// ==UserScript==
// @name         AmazonJP KUæ ‡è®°å·²å€Ÿé˜…
// @namespace    http://tampermonkey.net/
// @version      1.4
// @description  Amazon.co.jp Kindleæœç´¢ç»“æžœæ ‡è®°å·²å€Ÿé˜…å›¾ä¹¦ï¼ˆæ”¯æŒä¸­æ–‡/æ—¥æ–‡ç•Œé¢ï¼Œè¯¦æƒ…é¡µ+å€Ÿé˜…æˆåŠŸé¡µè‡ªåŠ¨æŠ“å–ï¼Œå«å¯¼å‡ºå¤‡ä»½åŠŸèƒ½ï¼‰
// @author       Gemini & You
// @match        https://www.amazon.co.jp/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=amazon.co.jp
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    // --- é…ç½®é¡¹ ---
    const STORAGE_KEY = 'ku_borrowed_asins';

    // --- æ ·å¼æ³¨å…¥ ---
    GM_addStyle(`
        .ku-borrowed-mark {
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            background-color: #2ecc71;
            border-radius: 50%;
            z-index: 100;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            margin-top: 2px;
            margin-left: 2px;
        }
        .ku-borrowed-mark::after {
            content: '';
            display: block;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            margin-bottom: 1px;
        }
        .s-product-image-container, .s-image-fixed-height {
            position: relative !important;
        }
    `);

    // --- æ ¸å¿ƒæ•°æ®ç®¡ç† ---

    function getBorrowedASINs() {
        const stored = GM_getValue(STORAGE_KEY, []);
        return new Set(stored);
    }

    function addASIN(asin) {
        if (!asin) return;
        const currentSet = getBorrowedASINs();
        if (!currentSet.has(asin)) {
            currentSet.add(asin);
            GM_setValue(STORAGE_KEY, Array.from(currentSet));
            console.log(`[KU Marker] æˆåŠŸè®°å½•å·²å€Ÿé˜… ASIN: ${asin}`);
        }
    }

    // --- èœå•åŠŸèƒ½ ---
    function importASINs() {
        const input = prompt("ã€å¯¼å…¥ã€‘\nè¯·ç²˜è´´ASINåˆ—è¡¨ (ç”¨é€—å·ã€ç©ºæ ¼æˆ–æ¢è¡Œåˆ†éš”):");
        if (input) {
            const asins = input.split(/[\s,]+/).filter(s => s.trim().length > 0);
            const currentSet = getBorrowedASINs();
            let count = 0;
            asins.forEach(asin => {
                const cleanAsin = asin.trim();
                if (cleanAsin && !currentSet.has(cleanAsin)) {
                    currentSet.add(cleanAsin);
                    count++;
                }
            });
            GM_setValue(STORAGE_KEY, Array.from(currentSet));
            alert(`æˆåŠŸå¯¼å…¥ ${count} ä¸ªæ–° ASINã€‚è¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæžœã€‚`);
        }
    }

    function exportASINs() {
        const currentSet = getBorrowedASINs();
        if (currentSet.size === 0) {
            alert("å½“å‰è¿˜æ²¡æœ‰è®°å½•ä»»ä½• ASINï¼Œæ— éœ€å¯¼å‡ºã€‚");
            return;
        }
        const listStr = Array.from(currentSet).join(',');
        prompt("ã€å¯¼å‡º/å¤‡ä»½ã€‘\nè¯·å¤åˆ¶ä¸‹æ–¹æ‰€æœ‰å†…å®¹ï¼Œå¹¶åœ¨æ–°ç”µè„‘ä¸Šé€šè¿‡â€œå¯¼å…¥â€åŠŸèƒ½ç²˜è´´ï¼š", listStr);
    }

    GM_registerMenuCommand("âž• æ‰¹é‡å¯¼å…¥ ASIN", importASINs);
    GM_registerMenuCommand("ðŸ“¤ å¯¼å‡º/å¤‡ä»½å·²è®°å½• ASIN", exportASINs);
    GM_registerMenuCommand("ðŸ“Š æŸ¥çœ‹å·²å­˜å‚¨æ•°é‡", () => {
        alert(`å½“å‰å·²è®°å½• ${getBorrowedASINs().size} æœ¬å€Ÿé˜…å›¾ä¹¦ã€‚`);
    });

    // --- é¡µé¢é€»è¾‘ï¼šè¯¦æƒ…é¡µæŠ“å– ---

    function checkDetailPage() {
        // æŽ’é™¤æŽ‰ thankYouPageï¼Œé¿å…é€»è¾‘å†²çªï¼ˆè™½ç„¶ä¸€èˆ¬ä¸ä¼šï¼Œä½†ä¸¥è°¨ä¸€ç‚¹ï¼‰
        if (window.location.href.includes('/thankYouPage')) return;

        const asinInput = document.getElementById('ASIN') || document.querySelector('input[name="ASIN"]');
        const currentASIN = asinInput ? asinInput.value : null;
        if (!currentASIN) return;
        const bodyText = document.body.innerText;
        const isBorrowed = bodyText.includes("é€šè¿‡ Kindle Unlimited åŒ…æœˆæœåŠ¡å€Ÿé˜…") ||
                           bodyText.includes("åˆ©ç”¨ã‚’çµ‚äº†") ||
                           bodyText.includes("ãŠå®¢æ§˜ã¯ã€ã“ã®å•†å“ã‚’ã™ã§ã«Kindle Unlimitedã§åˆ©ç”¨ã—ã¦ã„ã¾ã™");

        if (isBorrowed) {
            addASIN(currentASIN);
        }
    }

    // --- é¡µé¢é€»è¾‘ï¼šå€Ÿé˜…æˆåŠŸé¡µæŠ“å– (æ–°å¢ž) ---
    function checkThankYouPage() {
        // 1. æ£€æŸ¥ URL æ˜¯å¦åŒ…å« thankYouPage
        if (!window.location.href.includes('/kindle-dbs/thankYouPage')) return;

        // 2. ä»Ž URL å‚æ•°ä¸­æå– ASIN
        const urlParams = new URLSearchParams(window.location.search);
        const asin = urlParams.get('asin');

        if (asin) {
            // 3. äºŒæ¬¡ç¡®è®¤é¡µé¢å†…å®¹ï¼ˆç¡®ä¿æ˜¯å€Ÿé˜…æˆåŠŸï¼Œè€Œä¸æ˜¯è´­ä¹°æˆ–å…¶ä»–ï¼‰
            // åªè¦é¡µé¢åŒ…å« "å·²åŠ å…¥æ‚¨çš„å›¾ä¹¦é¦†" æˆ–è€…æ—¥è¯­ "ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«è¿½åŠ ã•ã‚Œã¾ã—ãŸ"ï¼Œå°±è§†ä¸ºæˆåŠŸ
            const bodyText = document.body.innerText;
            const successKeywords = [
                "å·²åŠ å…¥æ‚¨çš„å›¾ä¹¦é¦†",
                "ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«è¿½åŠ ã•ã‚Œã¾ã—ãŸ",
                "Kindle Unlimited", // é€šå¸¸æˆåŠŸé¡µä¹Ÿä¼šæåˆ° KU
                "é˜…è¯»å™¨å¼€å§‹é˜…è¯»"
            ];

            // åªè¦åŒ¹é…ä»»æ„ä¸€ä¸ªå…³é”®è¯ï¼Œå°±è®°å½•
            if (successKeywords.some(keyword => bodyText.includes(keyword))) {
                addASIN(asin);
            }
        }
    }

    // --- é¡µé¢é€»è¾‘ï¼šæœç´¢åˆ—è¡¨æ¸²æŸ“ ---

    function markSearchResults() {
        const borrowedSet = getBorrowedASINs();
        if (borrowedSet.size === 0) return;

        const items = document.querySelectorAll('[data-asin]');

        items.forEach(item => {
            const asin = item.getAttribute('data-asin');
            if (borrowedSet.has(asin)) {
                let targetContainer = item.querySelector('.s-product-image-container');
                if (!targetContainer) {
                    targetContainer = item.querySelector('.s-image-fixed-height');
                }

                if (targetContainer) {
                    if (targetContainer.querySelector('.ku-borrowed-mark')) return;
                    const mark = document.createElement('div');
                    mark.className = 'ku-borrowed-mark';
                    mark.title = 'å·²å€Ÿé˜… (è„šæœ¬è®°å½•)';
                    targetContainer.appendChild(mark);
                }
            }
        });
    }

    // --- åˆå§‹åŒ–ä¸Žæ‰§è¡Œ ---

    // 1. è¯¦æƒ…é¡µæ£€æµ‹
    if (document.querySelector('#dp') || window.location.href.includes('/dp/')) {
        setTimeout(checkDetailPage, 1500);
    }

    // 2. å€Ÿé˜…æˆåŠŸé¡µæ£€æµ‹ (æ–°å¢ž)
    checkThankYouPage();

    // 3. æœç´¢åˆ—è¡¨æ¸²æŸ“ (ç›‘å¬æ»šåŠ¨)
    const observer = new MutationObserver((mutations) => {
        markSearchResults();
    });
    observer.observe(document.body, { childList: true, subtree: true });

    markSearchResults();

})();